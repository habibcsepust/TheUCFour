@model TheUCFour.Models.PurchaseViewModel
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section MyStyle
{
    <style>
        input[type=text], select {
            width: 20%;
            padding: 0px 0px;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            background: #ccccff;
        }

        input[type=submit] {
            width: 12%;
            background-color: #4CAF50;
            color: white;
            text-align: center;
            padding: 10px 14px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 55%;
        }

            input[type=submit]:hover {
                background-color: #45a049;
            }

        /*For table*/
        #customers {
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            border-collapse: collapse;
            width: 100%;
            margin: 0 auto;
        }

            #customers td, #customers th {
                border: 1px solid #ddd;
                padding: 8px;
            }

            #customers tr:nth-child(even) {
                background-color: #f2f2f2;
            }

            #customers tr:hover {
                background-color: #ddd;
            }

            #customers th {
                padding-top: 12px;
                padding-bottom: 12px;
                text-align: left;
                background-color: #4CAF50;
                color: white;
                text-align: center;
            }

            #customers tr td label {
                margin: 0 auto;
            }

            #customers tr td input {
                width: 100%;
                padding: 3px;
            }

        #Remarks {
            width: 100%;
            padding: 5px;
        }

        #Add {
            float: right;
            padding: 4px;
            width: 6%;
            background: #ff8000;
        }

        /*************Second Table***************/
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            /*background-color: #dddddd;*/
        }

        #tblsubmit {
            float: right;
            width: 12%;
        }
    </style>

    <style>
        .table-dark {
            color: #fff;
            background-color: #663300;
        }

            .table-dark th,
            .table-dark td,
            .table-dark thead th {
                border-color: #FF860D;
            }
    </style>
}



<div>
    <h2 style="text-align:center;">Purchase Details</h2>
    <h3>Supplier</h3>
    <form method="post">
        <div>
            <fieldset>
                <legend style="border:1px solid #ced9d1;padding:10px;background:#804d00;color:white">

                    <div class="container">
                        <div class="row">
                            <div class="col-md-1.5">
                                @Html.LabelFor(c => c.Date)
                            </div>
                            <div class="col-md-3">
                                @*@Html.TextBoxFor(c => c.Date, new { @class = "form-control", id = "suppDate", style = "width:100%" })*@
                                <input type="date" name="Date" id="Date" style="background:gray;" />
                            </div>
                            <div class="col-md-1.5">
                                @Html.LabelFor(c => c.InvoiceNo)
                            </div>
                            <div class="col-md-3">
                                @Html.TextBoxFor(c => c.InvoiceNo, Model.InvoiceNo, new { @class = "form-control", style = "width:100%" })
                                <p id="Invoice" style="color:red;"></p>
                            </div>
                            <div class="col-md-1.5">
                                @Html.LabelFor(c => c.Supplier)
                            </div>
                            <div class="col-md-2.5">
                                @Html.DropDownListFor(c => c.SupplierId, Model.SupplierSelectListItems, "--Select--", new { @class = "form-control" })
                            </div>
                        </div>

                        <div class="row">

                            <div class="col-md-5"></div>
                            <div class="col-md-3">
                                <span style="color:red;">
                                    @Html.ValidationMessageFor(c => c.InvoiceNo)
                                </span>
                            </div>
                        </div>

                    </div>

                </legend>
            </fieldset>
        </div>

        <div>
            <h3>Product Details</h3>
            <table id="customers">
                <tr>
                    <td>Category</td>
                    <td>@Html.DropDownList("CategoryId", null, "--Select--", new { @class = "form-control" })</td>
                    @*<td><label for="Product">Product</label></td>
                        <td><input type="text" id="ProductId" name="ProductId"></td>*@

                    <td>Product</td>
                    <td>
                        <select id="ProductId" class="form-control">
                            <option>--Select--</option>
                        </select>
                    </td>
                    @*<td><label for="Product">Product</label></td>
                        <td><input type="text" id="CategoryId" name="CategoryId"></td>*@

                    <td><label for="Code">Code</label></td>
                    <td><input type="text" id="Code" name="Code"></td>
                </tr>
                <tr>
                    <td><label for="AvailableQuantity">Available Quantity</label></td>
                    <td><input type="text" id="AvailableQuantity" name="AvailableQuantity"></td>

                    <td><label for="ManufactureDate">Manufacture Date</label></td>
                    <td><input type="text" id="ManufactureDate" name="ManufactureDate"></td>

                    <td><label for="ExpireDate">Expire Date</label></td>
                    <td><input type="text" id="ExpireDate" name="ExpireDate"></td>
                </tr>
                <tr>
                    <td><label for="Quantity">Quantity</label></td>
                    <td><input type="text" id="Quantity" name="Quantity"></td>

                    <td><label for="UnitPrice">Unit Price</label></td>
                    <td><input type="text" id="UnitPrice" name="UnitPrice"></td>

                    <td><label for="TotalPrice">Total Price</label></td>
                    <td><input type="text" id="TotalPrice" name="TotalPrice"></td>
                </tr>
                <tr>
                    <td><label for="PreviousUnitPrice">Previous<br />Unit Price</label></td>
                    <td><input type="text" id="PreviousUnitPrice" name="PreviousUnitPrice"></td>

                    <td><label for="PreviousMRP">Previous MRP</label></td>
                    <td><input type="text" id="PreviousMRP" name="PreviousMRP"></td>

                    <td><label for="MRP">MRP</label></td>
                    <td><input type="text" id="MRP" name="MRP"></td>
                </tr>
            </table>

            <table>
                <tr>
                    <td><label for="Remarks">Remarks:</label></td>
                    <td><textarea rows="2" cols="50" name="Remarks" id="Remarks"></textarea></td>
                </tr>
            </table>
            <input type="button" id="Add" value="Add" />
        </div>

        <div>
            <table>

                <thead>
                    <tr>
                        <td>Sl</td>
                        <td>Category</td>
                        <td>Product</td>
                        <td>Code</td>
                        <td>AvailableQuantity</td>
                        <td>ManufactureDate</td>
                        <td>ExpireDate</td>
                        <td>Quantity</td>
                        <td>UnitPrice</td>
                        <td>TotalPrice</td>
                        <td>PreviousUnitPrice</td>
                        <td>PreviousMRP</td>
                        <td>MRP</td>
                        <td>Remarks</td>
                    </tr>
                </thead>
                <tbody id="ResultDetailsTable">
                    @*<tr>
                            <td>Sl</td>
                            <td>Subject</td>
                            <td>Marks</td>
                        </tr>*@
                </tbody>

            </table>
        </div>
        <table>
            <tr>
                <td><input type="submit" value="Save" id="tblsubmit" /></td>
            </tr>
        </table>

    </form>
</div>


<br />
<span>
    @Html.ActionLink("Show All", "AddPurchase", "Purchase",
       new { @class = "pull-right", style = "text-decoration:none;" +
       "Background:#592a4d;Padding:6px 15px;color:white;font-weight:bold;"
       })
</span>
<span style="margin-bottom:2%;">
    <input type="text" name="Search" id="Search" value="" placeholder="Search"
           style="padding: 8px;" />
    <button id="SearchButton" style="padding: 6px 10px;">Search</button>
    <h4 id="required" style="color:red;"></h4>
</span>


<table class="table table-dark" id="purchase">
    <thead>
        <tr>
            <th>SL</th>
            <th>Supplier</th>
            <th>Date</th>
            <th>Invoice Number</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        @{
            int sl = 1;
        }
        @foreach (var supplier in Model.Purchases)
        {
            <tr>
                <td>@(sl++)</td>
                <td>@supplier.Supplier.Name</td>
                <td>@supplier.Date</td>
                <td>@supplier.InvoiceNo</td>
                <td>
                    <span>
                        @Html.ActionLink("View", "PurchaseDetails", "Purchase", new { Id = supplier.Id },
                           new { @class = "fa fa-eye", style = "color:white;text-decoration:none;font-weight:bold;" })
                    </span>
                </td>
            </tr>
        }
    </tbody>

</table>


@*<table>
        <thead>
            <tr>
                <th>SL</th>
                <th>Supplier</th>
                <th>Date</th>
                <th>Invoice Number</th>
            </tr>
        </thead>
        <tbody id="StudentDetails"></tbody>
    </table>*@

@section MyScript
{
    <script src="~/Scripts/jquery.validate.min.js"></script>
    <script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>


    

    @*Check Duplicate InvoiceNo*@
    <script>
        $(document).ready(function () {
            $("#InvoiceNo").keyup(function () {
                $("#Invoice").text("");
                var InvoiceNo = $("#InvoiceNo").val();
                var jsonRequestData = { InvoiceNo: InvoiceNo }

                $.ajax({
                    url: "/Purchase/CheckDuplicateInvoiceNo",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (data) {
                        //alert("Ajax Success.");

                        $.each(data, function (key, value) {
                            $("#Invoice").text("InvoiceNo is Already Exist");
                        });
                    },
                    error: function () {
                        alert("Ajax Failed.");
                    },
                });
            });
        });
    </script>


    @*For Live Search*@
    <script>
        $(document).ready(function () {
            $("#SearchButton").click(function () {
                if ($("#Search").val() == "") {
                    //alert("required..");
                    $("#required").text("Please Required Search Value");
                    return;
                }
                $("#required").text("");
                SearchTable($("#Search").val());
            });

            function SearchTable(value) {
                $("#purchase tbody tr").each(function () {
                    var found = 'false';
                    $(this).each(function () {
                        if ($(this).text().toLowerCase().indexOf(value.toLowerCase()) > 0) {
                            found = 'true';
                        }
                    });
                    if (found == 'true') {
                        $(this).show();
                    }
                    else {
                        $(this).hide();
                    }

                });
            }
        });
    </script>

    @*For Total Price*@
    <script>
        $(document).ready(function () {

            var quantity = 0;
            var unitPrice = 0;
            $("#Quantity").keyup(function () {
                if (!IsNullOrEmpty($("#Quantity").val())) {
                    quantity = parseInt($("#Quantity").val());
                }
                if (!IsNullOrEmpty($("#UnitPrice").val())) {
                    unitPrice = parseInt($("#UnitPrice").val());
                }
                $("#TotalPrice").val(quantity * unitPrice);
            });

            $("#UnitPrice").keyup(function () {
                if (!IsNullOrEmpty($("#Quantity").val())) {
                    quantity = parseInt($("#Quantity").val());
                }
                if (!IsNullOrEmpty($("#UnitPrice").val())) {
                    unitPrice = parseInt($("#UnitPrice").val());
                }
                $("#TotalPrice").val(quantity * unitPrice);
            });


            function IsNullOrEmpty(data) {
                if (data === "" || data === "" || isNaN(data)) {
                    return true;
                }
                return false;
            }
        });
    </script>

    @*For MRP*@
    <script>
        $(document).ready(function () {

            var unitPrice = 0;
            //var unitPrice = 0;
            $("#UnitPrice").keyup(function () {
                if (!IsNullOrEmpty($("#UnitPrice").val())) {
                    unitPrice = parseInt($("#UnitPrice").val());
                }

                $("#MRP").val(unitPrice * .25 + unitPrice);
            });

            function IsNullOrEmpty(data) {
                if (data === "" || data === "" || isNaN(data)) {
                    return true;
                }
                return false;
            }
        });
    </script>

    @*For Jquery Date*@
    <script>
        //Supplier date
        $(document).ready(function () {
            $('#suppDate').datepicker({
                dateFormat: "dd/mm/yy",
                changeMonth: true,
                changeYear: true,
                yearRange: "2000:2019",
                //showOn: "both",
                //buttonText: "<i class='fa fa-calendar'></i>"
            });
        });
        //Manufacture date
        $(document).ready(function () {
            $('#ManufactureDate').datepicker({
                dateFormat: "dd/mm/yy",
                changeMonth: true,
                changeYear: true,
                yearRange: "2000:2019",
            });
        });

        //Expire date
        $(document).ready(function () {
            $('#ExpireDate').datepicker({
                dateFormat: "dd/mm/yy",
                changeMonth: true,
                changeYear: true,
                yearRange: "2000:2019",
            });
        });

    </script>

    @*For Add Jquery Data*@
    <script>

        $(document).ready(function () {
            var index = 0;

            $('#Add').click(function () {
                if ($("#Date").val() == "" || $("#SupplierId").val() == "" || $("#InvoiceNo").val() == "") {
                    alert("Please Select Suppleir before you add details");
                    return;
                }

                if ($("#CategoryId").val() == "") {
                    alert("Please Select Category");
                    return;
                }

                if ($("#ProdctId").val() == "") {
                    alert("Please Select Prodct");
                    return;
                }

                if ($("#ManufactureDate").val() == "") {
                    alert("Please Select ManufactureDate");
                    return;
                }
                if ($("#ExpireDate").val() == "") {
                    alert("Please Select ExpireDate");
                    return;
                }

                if ($("#Quantity").val() == "") {
                    alert("Please Enter Qantity");
                    return;
                } 

                if ($("#UnitPrice").val() == "") {
                    alert("Please Enter UnitPrice");
                    return;
                }
                
                //getProductsFromTextBox();
                 
                var result = GetResultData();

                var resultRow = GerResultRow(result);

                $("#ResultDetailsTable").append(resultRow);
                
                index++;
            });

            function GetResultData() {
                var category = $('#CategoryId').val();
                var categoryName = $('#CategoryId option:selected').html();
                var product = $('#ProductId').val();
                var productName = $('#ProductId option:selected').text();
                var code = $('#Code').val();
                var availableQuantity = $('#AvailableQuantity').val();
                var manufactureDate = $('#ManufactureDate').val();
                var expireDate = $('#ExpireDate').val();
                var quantity = $('#Quantity').val();
                var unitPrice = $('#UnitPrice').val();
                var totalPrice = $('#TotalPrice').val();
                var previousUnitPrice = $('#PreviousUnitPrice').val();
                var previousMRP = $('#PreviousMRP').val();
                var MRP = $('#MRP').val();
                var remarks = $('#Remarks').val();

                return {
                    CategoryId: category, CategoryName: categoryName, ProductName: productName, ProductId: product, Code: code, AvailableQuantity: availableQuantity,
                    ManufactureDate: manufactureDate, ExpireDate: expireDate, Quantity: quantity, UnitPrice: unitPrice, TotalPrice: totalPrice,
                    PreviousUnitPrice: previousUnitPrice, PreviousMRP: previousMRP, MRP: MRP, Remarks: remarks
                }
            }

            var sl = index;
            function GerResultRow(result) {

                var categoryHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].CategoryId' value='" + result.CategoryId + "'></div>";
                var productHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].ProductId' value='" + result.ProductId + "'></div>";
                var codeHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].Code' value='" + result.Code + "'></div>";
                var aQuantityHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].AvailableQuantity' value='" + result.AvailableQuantity + "'></div>";
                var mDateHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].ManufactureDate' value='" + result.ManufactureDate + "'></div>";
                var eDateHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].ExpireDate' value='" + result.ExpireDate + "'></div>";
                var quantityHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].Quantity' value='" + result.Quantity + "'></div>";
                var uPriceHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].UnitPrice' value='" + result.UnitPrice + "'></div>";
                var tPriceHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].TotalPrice' value='" + result.TotalPrice + "'></div>";
                var pUPriceHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].PreviousUnitPrice' value='" + result.PreviousUnitPrice + "'></div>";
                var pMRPHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].PreviousMRP' value='" + result.PreviousMRP + "'></div>";
                var MRPHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].MRP' value='" + result.MRP + "'></div>";
                var remarksHidden = "<input type='hidden' name='PurchaseDetails[" + index + "].Remarks' value='" + result.Remarks + "'></div>";

                var startTr = "<tr>";
                var slCell = "<td class='text-success'>" + (++sl) + "</td>";
                var categoryCell = "<td class='text-success'>" + categoryHidden + result.CategoryName + "</td>";
                var productCell = "<td class='text-success'>" + productHidden + result.ProductName + "</td>";
                var codeCell = "<td class='text-success'>" + codeHidden + result.Code + "</td>";
                var aQuantityCell = "<td class='text-success'>" + aQuantityHidden + result.AvailableQuantity + "</td>";
                var mDateCell = "<td class='text-success'>" + mDateHidden + result.ManufactureDate + "</td>";
                var eDateCell = "<td class='text-success'>" + eDateHidden + result.ExpireDate + "</td>";
                var quantityCell = "<td class='text-success'>" + quantityHidden + result.Quantity + "</td>";
                var uPriceCell = "<td class='text-success'>" + uPriceHidden + result.UnitPrice + "</td>";
                var tPriceCell = "<td class='text-success'>" + tPriceHidden + result.TotalPrice + "</td>";
                var pUPricCell = "<td class='text-success'>" + pUPriceHidden + result.PreviousUnitPrice + "</td>";
                var pMRPCell = "<td class='text-success'>" + pMRPHidden + result.PreviousMRP + "</td>";
                var MRPCell = "<td class='text-success'>" + MRPHidden + result.MRP + "</td>";
                var remarksCell = "<td class='text-success'>" + remarksHidden + result.Remarks + "</td>";
                var endTr = "</tr>";

                return (startTr + slCell + categoryCell + productCell + codeCell
                    + aQuantityCell + mDateCell + eDateCell + quantityCell + uPriceCell
                    + tPriceCell + pUPricCell + pMRPCell + MRPCell + remarksCell + endTr);

            }

        });
    </script>

    @*For CategoryWise Product*@
    <script>
        $(document).ready(function () {
            $("#CategoryId").change(function () {
                var categoryId = $("#CategoryId").val();
                var jsonRequestData = { categoryId: categoryId }

                $.ajax({
                    url: "/Purchase/GetProductByCategoryId",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (data) {
                        //alert("Ajax Success.");
                        $("#ProductId").empty();
                        $("#ProductId").append('<option>--Select--</option>');
                        $.each(data, function (key, value) {
                            $("#ProductId").append('<option value = "' + value.Id + '">' + value.Name + '</option>');
                        });
                    },
                    error: function () {
                        alert("Ajax Failed.");
                    },
                });
            });
        });
    </script>

    @*For Product Code*@
    <script>
        $(document).ready(function () {
            $("#ProductId").change(function () {
                var productId = $("#ProductId").val();
                var jsonRequestData = { productId: productId }

                $.ajax({
                    url: "/Purchase/GetCodeByProductId",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (data) {
                        //alert("Ajax Success.");

                        $.each(data, function (key, value) {
                            $("#Code").val(value.Code);
                            //$("#MRP").val(value.Code);
                        });
                    },
                    error: function () {
                        alert("Ajax Failed.");
                    },
                });
            });
        });
    </script>

    @*For Showing Previous Unit Price*@
    <script>
        $(document).ready(function () {
            $("#ProductId").change(function () {
                var productId = $("#ProductId").val();
                var jsonRequestData = { productId: productId }

                $.ajax({
                    url: "/Purchase/GetPreviousUnitPriceByProductId",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (data) {
                        //alert(data.PreviousUnitPrice);
                        $("#PreviousUnitPrice").val(data.PreviousUnitPrice)
                        $("#PreviousMRP").val(data.PreviousMRP)
                    },
                    error: function () {
                        alert("Ajax Failed.");
                    },
                });
            });
        });
    </script>


    @*For Showing AvailableQuantity By ProductId*@
    <script>
        $(document).ready(function () {
            $("#ProductId").change(function () {
                var productId = $("#ProductId").val();
                var jsonRequestData = { productId: productId }

                $.ajax({
                    url: "/Purchase/GetAvailableQtyByProductId",
                    type: "POST",
                    data: jsonRequestData,
                    success: function (data) {
                        //alert(data.PreviousUnitPrice);
                        $("#AvailableQuantity").val(data)
                    },
                    error: function () {
                        alert("Ajax Failed For AvailableQuantity.");
                    },
                });
            });
        });
    </script>




    @*For Search Supplier*@
    @*<script>
            $(document).ready(function () {
                $("#SearchButton").keyup(function () {
                    var SearchData = $("#Search").val();
                    var jsonRequestData = { SearchData: SearchData }

                    $.ajax({
                        url: "/Purchase/SearchSupplier",
                        type: "POST",
                        data: jsonRequestData,
                        success: function (data) {
                            //alert(data);

                            $("#StudentDetails").empty();
                            $.each(data, function (key, value) {
                                $("#StudentDetails").append(GetResultRow(value));

                            });
                        },
                        error: function () {
                            alert("Ajax Failed.");
                        },
                    });
                });


                function GetResultRow(value) {
                    var sl = 0;
                    var startTr = "<tr>";
                    var slCell = "<td class='text-success'>" + (++sl) + "</td>";
                    var Name = "<td class='text-success'>" + value.SupplierId + "</td>";
                    var Date = "<td class='text-success'>" + value.Date + "</td>";
                    var InvoiceNo = "<td class='text-success'>" + value.InvoiceNo + "</td>";
                    var endTr = "</tr>";

                    return (startTr + slCell + Name + Date + InvoiceNo + endTr);
                }
            });
        </script>*@
}


